<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Judge - 开启你的编程之旅</title>
    <link rel="stylesheet" href="/css/index.css">
    <script>
        // XSS防护函数
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text ? text.replace(/[&<>"']/g, function(m) { return map[m]; }) : '';
        }

        function updateAuthUI(isLoggedIn, username = '') {
            const authContainer = document.getElementById('auth-container');
            
            if (isLoggedIn) {
                authContainer.innerHTML = `
                    <div class="user-profile" title="个人中心" onclick="toggleUserMenu(event)">
                        <div class="user-avatar">${username.charAt(0).toUpperCase()}</div>
                        <span>${escapeHtml(username)}</span>
                    </div>
                    <div class="user-menu-backdrop" id="user-menu-backdrop" onclick="hideUserMenu()"></div>
                    <div class="user-menu" id="user-menu">
                        <button type="button" class="user-menu-item" onclick="handleLogout(event)">退出登录</button>
                    </div>
                `;
            } else {
                authContainer.innerHTML = `
                    <a href="/login" class="btn-text" id="login-btn">登录 / 注册</a>
                `;
            }
        }

        function hideUserMenu() {
            const menu = document.getElementById('user-menu');
            const backdrop = document.getElementById('user-menu-backdrop');
            if (menu) menu.classList.remove('visible');
            if (backdrop) backdrop.classList.remove('visible');
            document.removeEventListener('click', onUserMenuDocumentClick);
        }

        function onUserMenuDocumentClick(event) {
            const profile = document.querySelector('.user-profile');
            const menu = document.getElementById('user-menu');
            if (!profile || !menu) {
                hideUserMenu();
                return;
            }
            if (!profile.contains(event.target) && !menu.contains(event.target)) {
                hideUserMenu();
            }
        }

        function toggleUserMenu(event) {
            event.stopPropagation();
            console.log('[toggleUserMenu] called');
            const menu = document.getElementById('user-menu');
            const backdrop = document.getElementById('user-menu-backdrop');
            if (!menu || !backdrop) {
                console.warn('[toggleUserMenu] menu or backdrop not found');
                return;
            }
            const isVisible = menu.classList.contains('visible');
            console.log('[toggleUserMenu] isVisible =', isVisible);
            if (isVisible) {
                hideUserMenu();
            } else {
                menu.classList.add('visible');
                backdrop.classList.add('visible');
                document.addEventListener('click', onUserMenuDocumentClick);
                console.log('[toggleUserMenu] menu opened');
            }
        }

        async function handleLogout(event) {
            event.stopPropagation();
            try {
                const response = await fetch('/api/logout', {
                    method: 'GET'
                });
                const data = await response.json();
                if (data.status === 0) {
                    window.location.reload();
                } else {
                    alert('登出失败：' + (data.reason || '未知错误'));
                }
            } catch (e) {
                alert('登出请求失败，请稍后重试');
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            console.log('[index] DOMContentLoaded');
            const authContainer = document.getElementById('auth-container');
            if (!authContainer) {
                console.error('[index] #auth-container not found');
                return;
            }
            authContainer.innerHTML = '<span class="btn-text loading">加载中...</span>';

            fetch('/api/user')
                .then(res => res.json())
                .then(data => {
                    console.log('[index] /api/user response', data);
                    if (data.status === 0 && data.username) {
                        updateAuthUI(true, data.username);
                    } else {
                        updateAuthUI(false);
                    }
                })
                .catch(err => {
                    console.error('[index] /api/user error', err);
                    updateAuthUI(false);
                });
        });
    </script>
</head>
<body>
    <!-- Background Shapes -->
    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <a href="/">
                <span>&lt;/&gt;</span> 冻梨OJ
            </a>
        </div>
        <div class="navbar-links">
            <a href="/" class="active">首页</a>
            <a href="/all_questions">题库</a>
            <a href="/contest">竞赛</a>
            <a href="/discussion">讨论</a>
            <a href="/games/index.html">加分娱乐站</a>
        </div>
        <div class="navbar-auth" id="auth-container">
            <!-- Will be populated by JS -->
            <a href="/login" class="btn-text">登录</a>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h1 class="hero-title">探索代码的<br>无限可能</h1>
            <p class="hero-subtitle">
                加入我们的在线编程社区，提升你的算法技能，
                为技术面试做好准备。这里有海量题目等你来挑战。
            </p>
            <a href="/all_questions" class="btn-primary">开始刷题 ></a>
        </div>
        
        <div class="hero-graphic">
            <div class="graphic-card">
                <div class="code-block">
                    <span class="code-line"><span class="keyword">class</span> <span class="function">Solution</span> {</span>
                    <span class="code-line">&nbsp;&nbsp;<span class="keyword">public</span>:</span>
                    <span class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="function">twoSum</span>(<span class="keyword">vector</span>&lt;<span class="keyword">int</span>&gt;& nums, <span class="keyword">int</span> target) {</span>
                    <span class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// 寻找数组中和为目标值的两个数</span></span>
                    <span class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; map;</span>
                    <span class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (<span class="keyword">int</span> i = 0; i < nums.size(); i++) {</span>
                    <span class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (map.count(target - nums[i])) {</span>
                    <span class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> {map[target - nums[i]], i};</span>
                    <span class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
                    <span class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map[nums[i]] = i;</span>
                    <span class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
                    <span class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> {};</span>
                    <span class="code-line">&nbsp;&nbsp;&nbsp;&nbsp;}</span>
                    <span class="code-line">};</span>
                </div>
            </div>
        </div>
    </section>

</body>
</html>
