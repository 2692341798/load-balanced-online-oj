<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>题库 - 冻梨OJ</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/all_questions.css">
    <script>
        // XSS防护
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text ? text.replace(/[&<>"']/g, function(m) { return map[m]; }) : '';
        }

        function hideUserMenu() {
            const menu = document.getElementById('user-menu');
            const backdrop = document.getElementById('user-menu-backdrop');
            if (menu) menu.classList.remove('visible');
            if (backdrop) backdrop.classList.remove('visible');
            document.removeEventListener('click', onUserMenuDocumentClick);
        }

        function onUserMenuDocumentClick(event) {
            const profile = document.querySelector('.user-profile');
            const menu = document.getElementById('user-menu');
            if (!profile || !menu) {
                hideUserMenu();
                return;
            }
            if (!profile.contains(event.target) && !menu.contains(event.target)) {
                hideUserMenu();
            }
        }

        function toggleUserMenu(event) {
            event.stopPropagation();
            console.log('[all_questions toggleUserMenu] called');
            const menu = document.getElementById('user-menu');
            const backdrop = document.getElementById('user-menu-backdrop');
            if (!menu || !backdrop) {
                console.warn('[all_questions toggleUserMenu] menu or backdrop not found');
                return;
            }
            const isVisible = menu.classList.contains('visible');
            console.log('[all_questions toggleUserMenu] isVisible =', isVisible);
            if (isVisible) {
                hideUserMenu();
            } else {
                menu.classList.add('visible');
                backdrop.classList.add('visible');
                document.addEventListener('click', onUserMenuDocumentClick);
                console.log('[all_questions toggleUserMenu] menu opened');
            }
        }

        async function handleLogout(event) {
            event.stopPropagation();
            try {
                const response = await fetch('/api/logout', {
                    method: 'GET'
                });
                const data = await response.json();
                if (data.status === 0) {
                    window.location.reload();
                } else {
                    alert('登出失败：' + (data.reason || '未知错误'));
                }
            } catch (e) {
                alert('登出请求失败，请稍后重试');
            }
        }

        function updateNavAuth(data) {
            const authContainer = document.getElementById('auth-container');
            if (data.status === 0 && data.username) {
                authContainer.innerHTML = `
                    <div class="user-profile" onclick="toggleUserMenu(event)">
                        <div class="user-avatar">${data.username.charAt(0).toUpperCase()}</div>
                        <span>${escapeHtml(data.username)}</span>
                    </div>
                    <div class="user-menu-backdrop" id="user-menu-backdrop" onclick="hideUserMenu()"></div>
                    <div class="user-menu" id="user-menu">
                        <button type="button" class="user-menu-item" onclick="handleLogout(event)">退出登录</button>
                    </div>
                `;
            } else {
                authContainer.innerHTML = `<a href="/login" class="btn-text">登录 / 注册</a>`;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            console.log('[all_questions] DOMContentLoaded');
            const authContainer = document.getElementById('auth-container');
            if (!authContainer) {
                console.error('[all_questions] #auth-container not found');
                return;
            }
            authContainer.innerHTML = '<span class="btn-text loading">加载中...</span>';

            fetch('/api/user')
                .then(res => res.json())
                .then(data => {
                    console.log('[all_questions] /api/user response', data);
                    updateNavAuth(data);
                })
                .catch(err => {
                    console.error('[all_questions] /api/user error', err);
                    updateNavAuth({status: -1});
                });
        });
    </script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <a href="/">
                <span>&lt;/&gt;</span> 冻梨OJ
            </a>
        </div>
        <div class="navbar-links">
            <a href="/">首页</a>
            <a href="/all_questions" class="active">题库</a>
            <a href="#">竞赛</a>
            <a href="#">讨论</a>
            <a href="#">求职</a>
        </div>
        <div class="navbar-auth" id="auth-container">
            <span class="btn-text loading">加载中...</span>
        </div>
    </nav>

    <div class="question-list-container">
        <div class="question-list-header">
            <h1>题库列表</h1>
            <p style="color: var(--text-secondary);">挑选适合你的题目进行挑战</p>
        </div>

        <table class="question-table">
            <thead>
                <tr>
                    <th style="width: 80px;">编号</th>
                    <th>标题</th>
                    <th style="width: 100px;">难度</th>
                </tr>
            </thead>
            <tbody>
                {{#question_list}}
                <tr>
                    <td>{{number}}</td>
                    <td><a href="/question/{{number}}" class="question-link">{{title}}</a></td>
                    <td><span class="difficulty-badge difficulty-{{star}}">{{star}}</span></td>
                </tr>
                {{/question_list}}
            </tbody>
        </table>

        <div class="footer">
            &copy; 2026 冻梨在线判题平台
        </div>
    </div>
</body>
</html>
