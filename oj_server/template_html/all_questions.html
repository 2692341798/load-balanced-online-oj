<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢˜åº“ - å†»æ¢¨OJ</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/all_questions.css">
    <!-- Markdown Libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <script>
        // XSSé˜²æŠ¤
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text ? text.replace(/[&<>"']/g, function(m) { return map[m]; }) : '';
        }

        function hideUserMenu() {
            const menu = document.getElementById('user-menu');
            const backdrop = document.getElementById('user-menu-backdrop');
            if (menu) menu.classList.remove('visible');
            if (backdrop) backdrop.classList.remove('visible');
            document.removeEventListener('click', onUserMenuDocumentClick);
        }

        function onUserMenuDocumentClick(event) {
            const profile = document.querySelector('.user-profile');
            const menu = document.getElementById('user-menu');
            if (!profile || !menu) {
                hideUserMenu();
                return;
            }
            if (!profile.contains(event.target) && !menu.contains(event.target)) {
                hideUserMenu();
            }
        }

        function toggleUserMenu(event) {
            event.stopPropagation();
            console.log('[all_questions toggleUserMenu] called');
            const menu = document.getElementById('user-menu');
            const backdrop = document.getElementById('user-menu-backdrop');
            if (!menu || !backdrop) {
                console.warn('[all_questions toggleUserMenu] menu or backdrop not found');
                return;
            }
            const isVisible = menu.classList.contains('visible');
            console.log('[all_questions toggleUserMenu] isVisible =', isVisible);
            if (isVisible) {
                hideUserMenu();
            } else {
                menu.classList.add('visible');
                backdrop.classList.add('visible');
                document.addEventListener('click', onUserMenuDocumentClick);
                console.log('[all_questions toggleUserMenu] menu opened');
            }
        }

        async function handleLogout(event) {
            event.stopPropagation();
            try {
                const response = await fetch('/api/logout', {
                    method: 'GET'
                });
                const data = await response.json();
                if (data.status === 0) {
                    window.location.reload();
                } else {
                    alert('ç™»å‡ºå¤±è´¥ï¼š' + (data.reason || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('ç™»å‡ºè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        function updateNavAuth(data) {
            const authContainer = document.getElementById('auth-container');
            if (data.status === 0 && data.username) {
                authContainer.innerHTML = `
                    <div class="user-profile" onclick="toggleUserMenu(event)">
                        <div class="user-avatar">${data.username.charAt(0).toUpperCase()}</div>
                        <span>${escapeHtml(data.username)}</span>
                    </div>
                    <div class="user-menu-backdrop" id="user-menu-backdrop" onclick="hideUserMenu()"></div>
                    <div class="user-menu" id="user-menu">
                        <a href="/profile" class="user-menu-item">ä¸ªäººä¸­å¿ƒ</a>
                        <button type="button" class="user-menu-item" onclick="handleLogout(event)">é€€å‡ºç™»å½•</button>
                    </div>
                `;
            } else {
                authContainer.innerHTML = `<a href="/login" class="btn-text">ç™»å½• / æ³¨å†Œ</a>`;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            console.log('[all_questions] DOMContentLoaded');
            const authContainer = document.getElementById('auth-container');
            if (!authContainer) {
                console.error('[all_questions] #auth-container not found');
                return;
            }
            authContainer.innerHTML = '<span class="btn-text loading">åŠ è½½ä¸­...</span>';

            fetch('/api/user')
                .then(res => res.json())
                .then(data => {
                    console.log('[all_questions] /api/user response', data);
                    updateNavAuth(data);
                })
                .catch(err => {
                    console.error('[all_questions] /api/user error', err);
                    updateNavAuth({status: -1});
                });
        });

        // --- View Management ---
        function switchView(viewId) {
            // Hide all views
            ['view-question-list', 'view-discussion-feed', 'view-post-detail', 'view-editor'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            
            // Show target view
            const target = document.getElementById(viewId);
            if (target) {
                target.style.display = 'block';
                // Update nav active state
                document.querySelectorAll('.navbar-links a').forEach(a => a.classList.remove('active'));
                if (viewId === 'view-question-list') {
                    document.querySelector('a[href="/all_questions"]').classList.add('active');
                } else {
                    document.getElementById('nav-discussion').classList.add('active');
                }
            }
        }

        // --- Discussion Module Logic ---
        let simplemde = null;
        
        function initDiscussion() {
            // Mock Data
            const posts = [
                {
                    id: 1,
                    title: "2025 Rewind | å¼€å¯ä½ çš„å¹´åº¦æŠ¥å‘Š",
                    author: "LeetCode",
                    date: "2025-12-23",
                    summary: "å¹´åº¦è¿›åº¦æ¡å·²è¶‹è¿‘ 100%ï¼Œè°ƒç”¨ã€Œ2025 å¤ç›˜å·¥å…·ã€ï¼Œè§£é”ä½ çš„æˆé•¿æŠ¥å‘Š...",
                    tags: ["å¹´åº¦å›é¡¾", "å®˜æ–¹"],
                    likes: 43,
                    views: "8.5K",
                    comments: 92,
                    isOfficial: true
                },
                {
                    id: 2,
                    title: "åˆ†äº« | 800 é¢˜çºªå¿µ",
                    author: "Apior",
                    date: "11 å°æ—¶å‰",
                    summary: "æ—¶å…‰ä»“ä¿ƒï¼ŒçŠ¹å¦‚ä¸€æ¢¦ã€‚å›é¦–æ—¶ï¼Œä¸€ä¸ªå­¦æœŸå·²ç„¶ç”»ä¸Šå¥å·...",
                    tags: ["ç»éªŒåˆ†äº«", "é¢˜è§£"],
                    likes: 16,
                    views: 351,
                    comments: 3
                }
            ];
            
            renderFeed(posts);
        }

        function renderFeed(posts) {
            const container = document.getElementById('discussion-feed-list');
            if(!container) return;
            
            container.innerHTML = posts.map(post => `
                <div class="discussion-card" onclick="openPost(${post.id})">
                    <div class="card-header">
                        <div class="user-info">
                            <span class="username">${post.author}</span>
                            <span class="date">Â· ${post.date}</span>
                        </div>
                        ${post.isOfficial ? '<span class="tag-official">å®˜æ–¹</span>' : ''}
                    </div>
                    <h3 class="card-title">${post.title}</h3>
                    <p class="card-summary">${post.summary}</p>
                    <div class="card-footer">
                        <div class="stats">
                            <span>ğŸ‘ ${post.likes}</span>
                            <span>ğŸ‘ ${post.views}</span>
                            <span>ğŸ’¬ ${post.comments}</span>
                        </div>
                        <div class="tags">
                            ${post.tags.map(t => `<span class="tag">${t}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openPost(id) {
            // In a real app, fetch post details
            switchView('view-post-detail');
            // Mock render detail
            document.getElementById('post-detail-content').innerHTML = `
                <h1>2025 Rewind | å¼€å¯ä½ çš„å¹´åº¦æŠ¥å‘Š</h1>
                <div class="post-meta">LeetCode Â· 2025.12.23</div>
                <div class="markdown-body" id="post-markdown-content">
                    <p>å¹´åº¦è¿›åº¦æ¡å·²è¶‹è¿‘ 100% âœ…...</p>
                    <pre><code>git archive 2025 --format=zip -o growth_2025.zip</code></pre>
                    <p>è¿™æ˜¯ä¸€æ®µå¯ä»¥è¿›è¡Œæ®µå†…è¯„è®ºçš„æµ‹è¯•æ–‡æœ¬ã€‚è¯·å°è¯•é€‰ä¸­è¿™æ®µæ–‡å­—ã€‚</p>
                </div>
            `;
            initInlineComments();
        }

        function openEditor() {
            switchView('view-editor');
            if (!simplemde) {
                simplemde = new EasyMDE({ element: document.getElementById("editor-textarea") });
            }
        }
        
        // --- Backend API Integration Example ---
        async function savePost() {
            if (!simplemde) return;
            const content = simplemde.value();
            const title = "New Post"; // Should get from an input field
            
            try {
                // Example of sending data to backend
                const response = await fetch('/api/discussion/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        tags: ['tag1', 'tag2']
                    })
                });
                
                const result = await response.json();
                if (result.status === 0) {
                    alert('å‘å¸ƒæˆåŠŸ');
                    switchView('view-discussion-feed');
                    // Reload feed
                    initDiscussion();
                } else {
                    alert('å‘å¸ƒå¤±è´¥: ' + result.reason);
                }
            } catch (e) {
                console.error('Save post error:', e);
                // For demo purpose:
                alert('æ¼”ç¤ºæ¨¡å¼ï¼šå‘å¸ƒæˆåŠŸ');
                switchView('view-discussion-feed');
            }
        }

        // Inline Comment Logic
        function initInlineComments() {
            const content = document.getElementById('post-markdown-content');
            const tooltip = document.getElementById('inline-comment-tooltip');
            
            content.addEventListener('mouseup', (e) => {
                const selection = window.getSelection();
                if (selection.toString().length > 0) {
                    const range = selection.getRangeAt(0);
                    const rect = range.getBoundingClientRect();
                    
                    tooltip.style.display = 'block';
                    tooltip.style.top = (window.scrollY + rect.top - 40) + 'px';
                    tooltip.style.left = (window.scrollX + rect.left + rect.width / 2 - 40) + 'px';
                } else {
                    tooltip.style.display = 'none';
                }
            });
        }
    </script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <a href="/">
                <span>&lt;/&gt;</span> å†»æ¢¨OJ
            </a>
        </div>
        <div class="navbar-links">
            <a href="/">é¦–é¡µ</a>
            <a href="/all_questions" class="active">é¢˜åº“</a>
            <a href="#">ç«èµ›</a>
            <a href="javascript:void(0)" id="nav-discussion" onclick="switchView('view-discussion-feed'); initDiscussion();">è®¨è®º</a>
            <a href="#">æ±‚èŒ</a>
        </div>
        <div class="navbar-auth" id="auth-container">
            <span class="btn-text loading">åŠ è½½ä¸­...</span>
        </div>
    </nav>

    <div class="question-list-container">
        <div id="view-question-list">
            <div class="question-list-header">
                <h1>é¢˜åº“åˆ—è¡¨</h1>
                <p style="color: var(--text-secondary);">æŒ‘é€‰é€‚åˆä½ çš„é¢˜ç›®è¿›è¡ŒæŒ‘æˆ˜</p>
            </div>

            <table class="question-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">ç¼–å·</th>
                        <th>æ ‡é¢˜</th>
                        <th style="width: 100px;">éš¾åº¦</th>
                    </tr>
                </thead>
                <tbody>
                    {{#question_list}}
                    <tr>
                        <td>{{number}}</td>
                        <td><a href="/question/{{number}}" class="question-link">{{title}}</a></td>
                        <td><span class="difficulty-badge difficulty-{{star}}">{{star}}</span></td>
                    </tr>
                    {{/question_list}}
                </tbody>
            </table>
        </div>

        <!-- Discussion Views -->
        <div id="view-discussion-feed" style="display:none;">
            <div class="discussion-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1 style="color:var(--text-main)">è®¨è®ºåŒº</h1>
                <button class="btn-primary" onclick="openEditor()" style="padding:8px 16px; background:#2cbb5d; border:none; border-radius:4px; color:white; cursor:pointer;">+ å‘èµ·è®¨è®º</button>
            </div>
            <div id="discussion-feed-list"></div>
        </div>

        <div id="view-post-detail" style="display:none;">
            <button class="btn-back" onclick="switchView('view-discussion-feed')" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; margin-bottom:10px;">â† è¿”å›è®¨è®ºåŒº</button>
            <div id="post-detail-content" class="post-detail-container" style="background:var(--card-bg); padding:20px; border-radius:8px;"></div>
            <div id="inline-comment-tooltip" style="display:none; position:absolute; background:#333; padding:5px; border-radius:4px; z-index:1000; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                <button onclick="alert('æ·»åŠ è¯„è®ºåŠŸèƒ½')" style="background:none; border:none; color:white; cursor:pointer;">ğŸ’¬ è¯„è®º</button>
            </div>
        </div>

        <div id="view-editor" style="display:none;">
             <button class="btn-back" onclick="switchView('view-discussion-feed')" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; margin-bottom:10px;">â† å–æ¶ˆ</button>
             <h2 style="color:var(--text-main); margin-bottom:20px;">å‘å¸ƒæ–‡ç« </h2>
             <input type="text" id="post-title-input" placeholder="è¯·è¾“å…¥æ ‡é¢˜" style="width:100%; padding:10px; margin-bottom:15px; background:var(--card-bg); border:1px solid rgba(255,255,255,0.1); color:var(--text-main); border-radius:4px;">
             <textarea id="editor-textarea"></textarea>
             <div style="margin-top:20px; text-align:right;">
                <button class="btn-primary" onclick="savePost()" style="padding:8px 24px; background:#2cbb5d; border:none; border-radius:4px; color:white; cursor:pointer;">å‘å¸ƒ</button>
             </div>
        </div>

        <div class="footer">
            &copy; 2026 å†»æ¢¨åœ¨çº¿åˆ¤é¢˜å¹³å°
        </div>
    </div>
</body>
</html>
