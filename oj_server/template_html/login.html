<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录 / 注册 - 冻梨OJ</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/login.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <a href="/">
                <span>&lt;/&gt;</span> 冻梨OJ
            </a>
        </div>
        <div class="navbar-links">
            <a href="/">首页</a>
            <a href="/all_questions">题库</a>
        </div>
    </nav>

    <div class="login-page">
        <!-- 背景装饰 -->
        <div class="bg-shape shape-1" style="top: 10%; left: -5%;"></div>
        <div class="bg-shape shape-2" style="bottom: 10%; right: -5%;"></div>

        <div class="login-card">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('login')">登录</div>
                <div class="tab" onclick="switchTab('register')">注册</div>
            </div>
            
            <!-- Login Form -->
            <div id="login-form">
                <form id="login-form-element">
                    <div class="form-group">
                        <label>用户名</label>
                        <input type="text" id="login-username" placeholder="请输入用户名" required>
                    </div>
                    <div class="form-group">
                        <label>密码</label>
                        <input type="password" id="login-password" placeholder="请输入密码" required>
                    </div>
                    <div class="links">
                        <div class="checkbox-group">
                            <input type="checkbox" id="remember-me"> <label for="remember-me">记住我</label>
                        </div>
                        <a href="#">忘记密码?</a>
                    </div>
                    <div class="error" id="login-error"></div>
                    <button type="submit" id="login-submit-btn">登 录</button>
                    <div class="loading" id="login-loading">登录中...</div>
                </form>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="hidden">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="reg-username" placeholder="设置用户名 (3-20字符)" required>
                    <div class="form-validation" id="reg-username-validation"></div>
                </div>
                <div class="form-group">
                    <label>邮箱</label>
                    <input type="email" id="reg-email" placeholder="输入邮箱地址" required>
                    <div class="form-validation" id="reg-email-validation"></div>
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="reg-password" placeholder="设置密码" required oninput="checkPasswordStrength()">
                    <div class="password-strength">
                        <div class="password-strength-bar" id="password-strength-bar"></div>
                    </div>
                    <div class="form-validation" id="reg-password-validation"></div>
                </div>
                <div class="form-group">
                    <label>确认密码</label>
                    <input type="password" id="reg-confirm-password" placeholder="再次输入密码" required>
                    <div class="form-validation" id="reg-confirm-validation"></div>
                </div>
                <div class="error" id="reg-error"></div>
                <button onclick="handleRegister()" id="reg-submit-btn" class="btn-block">注 册</button>
                <div class="loading" id="reg-loading">注册中...</div>
            </div>
        </div>
    </div>

    <script>
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if (tab === 'login') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('register-form').classList.add('hidden');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            }
        }

        // Logic Reuse (Keeping the core logic similar to original but adapted for new IDs if needed)
        // ... (Include logic from original login.html but adapted)
        
        async function handleLogin(event) {
            if (event) event.preventDefault();
            
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const error = document.getElementById('login-error');
            const submitBtn = document.getElementById('login-submit-btn');
            const loading = document.getElementById('login-loading');
            
            error.classList.remove('visible');
            
            if(!username || !password) {
                error.textContent = "请输入用户名和密码";
                error.classList.add('visible');
                return;
            }

            submitBtn.classList.add('hidden');
            loading.classList.add('visible');

            // 增强的网络请求函数，支持重试和超时
            async function fetchWithRetry(url, options = {}, retries = 3, timeout = 5000) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                options.signal = controller.signal;

                try {
                    const response = await fetch(url, options);
                    clearTimeout(id);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    clearTimeout(id);
                    if (retries > 0) {
                        console.log(`Request failed, retrying... (${retries} attempts left)`);
                        await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒后重试
                        return fetchWithRetry(url, options, retries - 1, timeout);
                    }
                    throw error;
                }
            }

            try {
                const res = await fetchWithRetry('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                
                const data = await res.json();
                
                submitBtn.classList.remove('hidden');
                loading.classList.remove('visible');
                
                if (data.status === 0) {
                    window.location.href = '/all_questions';
                } else {
                    error.textContent = data.reason || "登录失败";
                    error.classList.add('visible');
                }
            } catch (e) {
                submitBtn.classList.remove('hidden');
                loading.classList.remove('visible');
                
                let errorMsg = "网络错误，请稍后重试";
                if (e.name === 'AbortError') {
                    errorMsg = "请求超时，请检查网络连接";
                } else if (e.message.includes('HTTP error')) {
                    errorMsg = `服务器连接失败 (${e.message})`;
                }
                
                error.textContent = errorMsg;
                error.classList.add('visible');
                console.error("Login failed:", e);
            }
        }

        // 注册逻辑同理，简化展示...
        // 实际开发中应该把这些 JS 提取到单独的 js 文件中，例如 login.js
        
        document.getElementById('login-form-element').addEventListener('submit', handleLogin);
        
        // 密码强度检查
        function checkPasswordStrength() {
            const password = document.getElementById('reg-password').value;
            const strengthBar = document.getElementById('password-strength-bar');
            
            let strength = 0;
            if (password.length >= 8) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            
            strengthBar.className = 'password-strength-bar';
            if (strength <= 1) strengthBar.classList.add('weak');
            else if (strength <= 3) strengthBar.classList.add('medium');
            else strengthBar.classList.add('strong');
        }

        async function handleRegister() {
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const confirm = document.getElementById('reg-confirm-password').value;
            const email = document.getElementById('reg-email').value;
            const error = document.getElementById('reg-error');
            
            if(password !== confirm) {
                error.textContent = "密码不一致";
                error.classList.add('visible');
                return;
            }

             try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password, email})
                });
                const data = await res.json();
                if (data.status === 0) {
                    alert('注册成功，请登录');
                    switchTab('login');
                } else {
                    error.textContent = data.reason;
                    error.classList.add('visible');
                }
            } catch(e) {
                error.textContent = "注册失败";
                error.classList.add('visible');
            }
        }
    </script>
</body>
</html>
