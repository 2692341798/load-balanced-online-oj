<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>竞赛列表 - 冻梨OJ</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/contest-list.css">
    <script>
        // XSS防护
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text ? text.replace(/[&<>"']/g, function(m) { return map[m]; }) : '';
        }

        function hideUserMenu() {
            const menu = document.getElementById('user-menu');
            const backdrop = document.getElementById('user-menu-backdrop');
            if (menu) menu.classList.remove('visible');
            if (backdrop) backdrop.classList.remove('visible');
            document.removeEventListener('click', onUserMenuDocumentClick);
        }

        function onUserMenuDocumentClick(event) {
            const profile = document.querySelector('.user-profile');
            const menu = document.getElementById('user-menu');
            if (!profile || !menu) {
                hideUserMenu();
                return;
            }
            if (!profile.contains(event.target) && !menu.contains(event.target)) {
                hideUserMenu();
            }
        }

        function toggleUserMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('user-menu');
            const backdrop = document.getElementById('user-menu-backdrop');
            if (!menu || !backdrop) return;
            
            const isVisible = menu.classList.contains('visible');
            if (isVisible) {
                hideUserMenu();
            } else {
                menu.classList.add('visible');
                backdrop.classList.add('visible');
                document.addEventListener('click', onUserMenuDocumentClick);
            }
        }

        async function handleLogout(event) {
            event.stopPropagation();
            try {
                const response = await fetch('/api/logout', { method: 'GET' });
                const data = await response.json();
                if (data.status === 0) {
                    window.location.reload();
                } else {
                    alert('登出失败：' + (data.reason || '未知错误'));
                }
            } catch (e) {
                alert('登出请求失败，请稍后重试');
            }
        }

        function updateNavAuth(data) {
            const authContainer = document.getElementById('auth-container');
            if (data.status === 0 && data.username) {
                authContainer.innerHTML = `
                    <div class="user-profile" onclick="toggleUserMenu(event)">
                        <div class="user-avatar">${data.username.charAt(0).toUpperCase()}</div>
                        <span>${escapeHtml(data.username)}</span>
                    </div>
                    <div class="user-menu-backdrop" id="user-menu-backdrop" onclick="hideUserMenu()"></div>
                    <div class="user-menu" id="user-menu">
                        <a href="/profile" class="user-menu-item">个人中心</a>
                        <button type="button" class="user-menu-item" onclick="handleLogout(event)">退出登录</button>
                    </div>
                `;
            } else {
                authContainer.innerHTML = `<a href="/login" class="btn-text">登录 / 注册</a>`;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const authContainer = document.getElementById('auth-container');
            if (authContainer) {
                authContainer.innerHTML = '<span class="btn-text loading">加载中...</span>';
                fetch('/api/user')
                    .then(res => res.json())
                    .then(data => updateNavAuth(data))
                    .catch(err => updateNavAuth({status: -1}));
            }
        });
    </script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <a href="/">
                <span>&lt;/&gt;</span> 冻梨OJ
            </a>
        </div>
        <div class="navbar-links">
            <a href="/">首页</a>
            <a href="/all_questions">题库</a>
            <a href="/contest" class="active">竞赛</a>
            <a href="/discussion">讨论</a>
            <a href="#">求职</a>
        </div>
        <div class="navbar-auth" id="auth-container">
            <!-- JS will populate this -->
            {{#user_logged_in}}
             <!-- Server-side fallback/hydration if needed, but JS will overwrite -->
            {{/user_logged_in}}
        </div>
    </nav>

    <div class="contest-container">
        <div class="contest-header">
            <h1>
                <img src="/images/codeforces-sponsored-by-ton.png.webp" alt="Codeforces Logo" class="cf-logo">
                近期竞赛
            </h1>
            <div class="contest-controls">
                <label>
                    <input type="checkbox" id="filter-running"> 仅显示进行中
                </label>
            </div>
        </div>
        
        <div class="contest-table-wrapper">
            <table class="contest-table" id="contest-table">
                <thead>
                    <tr>
                        <th class="col-name">竞赛名称</th>
                        <th class="col-time">开始时间</th>
                        <th class="col-time">结束时间</th>
                        <th class="col-status">状态</th>
                        <th class="col-action">操作</th>
                    </tr>
                </thead>
                <tbody id="contest-list-body">
                    <!-- JS populated -->
                </tbody>
            </table>
        </div>

        <div class="pagination-container">
            <button id="btn-prev" onclick="changePage(-1)">上一页</button>
            <span id="page-info">第 1 页</span>
            <button id="btn-next" onclick="changePage(1)">下一页</button>
        </div>

        <div class="last-updated" id="last-updated">
            数据更新时间: {{updated_at}}
        </div>
        
        <div class="footer">
            &copy; 2026 冻梨在线判题平台
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        const pageSize = 5;

        async function fetchContests() {
            const onlyRunning = document.getElementById('filter-running').checked;
            const status = onlyRunning ? 'running' : '';
            
            try {
                const res = await fetch(`/api/contests?page=${currentPage}&size=${pageSize}&status=${status}`);
                const data = await res.json();
                
                if (data.status === 0) {
                    renderTable(data.data);
                    totalPages = data.total_pages || 1;
                    document.getElementById('page-info').textContent = `第 ${data.page} / ${data.total_pages || 1} 页`;
                    document.getElementById('btn-prev').disabled = currentPage <= 1;
                    document.getElementById('btn-next').disabled = currentPage >= totalPages;
                } else {
                    console.error('获取数据失败: ' + data.reason);
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderTable(list) {
            const tbody = document.getElementById('contest-list-body');
            tbody.innerHTML = '';
            
            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;">暂无数据</td></tr>';
                return;
            }

            list.forEach(item => {
                let statusClass = '';
                let statusText = '';
                let actionBtn = '';
                
                if (item.status === 'running') {
                    statusClass = 'status-running';
                    statusText = '进行中';
                    actionBtn = `<a href="${item.link}" target="_blank" class="btn-primary">进入</a>`;
                } else if (item.status === 'upcoming') {
                    statusClass = 'status-upcoming';
                    statusText = '未开始';
                    actionBtn = `<a href="${item.link}" target="_blank" class="btn-primary">报名</a>`;
                } else {
                    statusClass = 'status-ended';
                    statusText = '已结束';
                    actionBtn = `<a href="${item.link}" target="_blank" class="btn-secondary">查看</a>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="col-name" data-label="竞赛名称">${escapeHtml(item.name)}</td>
                    <td class="col-time" data-label="开始时间">${item.start_time}</td>
                    <td class="col-time" data-label="结束时间">${item.end_time}</td>
                    <td class="col-status" data-label="状态">
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </td>
                    <td class="col-action">
                        ${actionBtn}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                fetchContests();
            }
        }
        
        document.getElementById('filter-running').addEventListener('change', () => {
            currentPage = 1;
            fetchContests();
        });

        // Initial load
        fetchContests();
    </script>
</body>
</html>